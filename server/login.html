<!doctype html>
<html lang="eng">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FixCraft - Login</title>
  <link rel="icon" type="image/png" href="/open/lock.png">
  <!--LOGIN_CONFIG_SCRIPT-->
  <!-- GTM -->
  <script>
  (function(){
    const cfg = window.__LOGIN_PAGE_CONFIG__ || {};
    const gtmId = cfg.gtmId;
    if (!gtmId) return;
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer',gtmId);
  })();
  </script>

  <!-- Cloudflare Turnstile (explicit render but VISIBLE) -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=cfOnload&render=explicit" async defer></script>

  <style>
    :root{
      --bg:#07090d; --ink:#e6edf3; --muted:#98a2b3;
      --card1:#0a0b0f; --card2:#090b10;
      --stroke:#10131a; --stroke2:#151922;
      --accent:#2b75ff; --accent2:#6A3DE8;
      --dim:rgba(0,0,0,.55);
      --ring:0 0 0 3px rgba(43,117,255,.18), inset 0 0 0 1px rgba(43,117,255,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font:14px ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:#0b0f14; color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    body.obsidian{ background:var(--bg); }
    .card{
      width:min(380px,92vw);
      background:linear-gradient(180deg,var(--card1),var(--card2));
      border:1px solid var(--stroke);
      border-radius:16px; padding:24px 22px 18px;
      box-shadow:0 10px 40px rgba(0,0,0,.55);
      backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px);
      transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
      position:relative; z-index:10;
    }
    .fx-active .card{ transform:translateY(-1px) }
    .obsidian .card{ border-color:var(--stroke2); box-shadow:0 12px 48px rgba(0,0,0,.65) }
    h1{margin:2px 2px 14px; font-size:20px; letter-spacing:.2px}
    label{display:block; margin:12px 3px 6px; font-size:12.5px; color:var(--muted)}
    .field{
      width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--stroke2);
      background:#080a0e; color:var(--ink); outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .2s ease;
    }
    .field::placeholder{ color:#6f7a87 }
    .field:focus{ border-color:#1b3cff; box-shadow:var(--ring); background:#0b0f16; }
    .btn{
      width:100%; margin-top:16px; padding:12px 14px; border:0; border-radius:12px; color:#fff; font-weight:700; cursor:pointer;
      background:linear-gradient(45deg,#2BA7FF,var(--accent2));
      box-shadow:0 8px 28px rgba(43,167,255,.25), 0 12px 34px rgba(106,61,232,.18);
      transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ transform:translateY(-1px) }
    .btn[disabled]{ opacity:.6; filter:saturate(.6); cursor:not-allowed; box-shadow:none; }
    .muted{margin-top:12px; font-size:12px; color:var(--muted); text-align:center}
    .perm-required{margin-top:12px; font-size:12px; color:#fbbf24; text-align:center; display:none;}
    .perm-required.show{display:block; color:#f97316;}
    .bg-split{ position:fixed; inset:0; z-index:-1; display:none; background:#000; pointer-events:none; overflow:hidden; contain:strict; }
    .bg-split.active{ display:block }
    .bg-split::after{ content:""; position:absolute; inset:0; background:var(--dim) }
    .bg-split video.half{ position:absolute; top:0; height:100vh; width:50vw; object-fit:cover; will-change:transform; transform:translateZ(0) }
    .bg-split .left{ left:0 } .bg-split .right{ right:0 }
    #bgMaster{ position:absolute; width:1px; height:1px; opacity:0; pointer-events:none }

    /* visible widget box */
    #cfBox{ margin-top:10px }
    #cfMsg{ display:none; margin-top:8px; font-size:12px; color:#fca5a5; text-align:center; }
    #cfMsg.show{ display:block; }
    #loginError{ display:none; margin-top:12px; font-size:12.5px; color:#f87171; text-align:center; }
    #loginError.show{ display:block; }
  </style>
</head>
<body class="obsidian">
  <!--GTM_NOSCRIPT-->

  <!-- BG split -->
  <div class="bg-split" id="bgSplit" aria-hidden="true">
    <!-- <video id="bgMaster" preload="auto" playsinline loop disablepictureinpicture controlslist="nodownload noplaybackrate noremoteplayback">
      <source src="/login-bg.mp4" type="video/mp4">
    </video> -->
    <video class="half left"  id="bgL" muted playsinline autoplay disablepictureinpicture controlslist="nodownload noplaybackrate noremoteplayback"></video>
    <video class="half right" id="bgR" muted playsinline autoplay disablepictureinpicture controlslist="nodownload noplaybackrate noremoteplayback"></video>
  </div>

  <form class="card" id="loginForm" method="post" action="/login" autocomplete="on">
    <h1>Login to FixCraft</h1>

    <label for="u">Username</label>
    <input id="u" class="field" name="username" required autocomplete="username" placeholder="Username">

    <label for="p">Password</label>
    <input id="p" class="field" name="password" type="password" required autocomplete="current-password" placeholder="••••••••">

    <!-- Visible Turnstile mount -->
    <div id="cfBox"></div>
    <div id="cfMsg">Please verify you are human.</div>
    <div id="permMsg" class="perm-required"></div>
    <div id="loginError"></div>

    <input type="hidden" id="nextField" name="next">

    <button type="submit" id="loginBtnn" class="btn" disabled>Log In</button>
    <div class="muted">Access only to trusted members, unauthorized access is a felony!</div>
  </form>

  <script src="/permission-guard.js"></script>
  <script>
    // Enable button when both fields non-empty
    const u=document.getElementById('u'), p=document.getElementById('p'), btn=document.getElementById('loginBtnn');
    const form=document.getElementById('loginForm'), msg=document.getElementById('cfMsg');
    const errBox=document.getElementById('loginError');
    const permMsg=document.getElementById('permMsg');
    let permissionsReady=false;
    let latestPermissionIssues=[];
    const loginConfig = window.__LOGIN_PAGE_CONFIG__ || {};
    const TURNSTILE_SITE_KEY = loginConfig.turnstileSiteKey || "";
    if (!TURNSTILE_SITE_KEY && msg) {
      msg.textContent = 'Security verification is not configured. Please contact an administrator.';
      msg.classList.add('show');
    }

    const clearError = () => { if (errBox) errBox.classList.remove('show'); };

    const formatIssueSummary = (issues) => {
      if (!Array.isArray(issues) || !issues.length) return '';
      const labelMap={
        'notifications':'notifications',
        'geolocation':'location access',
        'dark-mode':'dark mode',
      };
      const parts=issues.map((code)=>labelMap[code]).filter(Boolean);
      if (!parts.length) return '';
      if (parts.length===1) return parts[0];
      if (parts.length===2) return parts[0]+' and '+parts[1];
      return parts.slice(0,-1).join(', ')+', and '+parts[parts.length-1];
    };

    const updatePermissionMessage = () => {
      if (!permMsg) return;
      const summary=formatIssueSummary(latestPermissionIssues);
      if (!permissionsReady && summary) {
        permMsg.textContent='Please enable '+summary+' to sign in.';
        permMsg.classList.add('show');
      } else {
        permMsg.classList.remove('show');
      }
    };

    const updateSubmitState = () => {
      const fieldsReady=Boolean(u.value.trim() && p.value.trim());
      const allow=fieldsReady && permissionsReady;
      btn.disabled = !allow;
      updatePermissionMessage();
    };

    const handleInput = () => {
      clearError();
      updateSubmitState();
    };

    u.addEventListener('input', handleInput);
    p.addEventListener('input', handleInput);
    updateSubmitState();

    if (window.PermissionGuard) {
      window.PermissionGuard.start({
        requireDarkMode: true,
        requireNotifications: true,
        requireGeolocation: true,
        onStatusChange: ({ allGranted, issues }) => {
          permissionsReady = Boolean(allGranted);
          latestPermissionIssues = Array.isArray(issues) ? issues : [];
          updateSubmitState();
        },
      });
    } else {
      updatePermissionMessage();
    }

    const params = new URLSearchParams(window.location.search);
    const nextField = document.getElementById('nextField');
    const nextValue = params.get('next');
    if (nextField && nextValue && nextValue.startsWith('/')) {
      nextField.value = nextValue;
    }
    if (errBox) {
      const errorType = params.get('error');
      if (errorType === 'invalid') {
        errBox.textContent = 'Invalid username or password.';
        errBox.classList.add('show');
      } else if (errorType === 'captcha') {
        errBox.textContent = 'Verification failed. Please complete the Turnstile challenge.';
        errBox.classList.add('show');
      }
    }

    // Robust Turnstile boot (works regardless of load order)
    let CF_WIDGET_ID = null;
    function renderTurnstile(){
      if (!TURNSTILE_SITE_KEY) return;
      if (!window.turnstile || CF_WIDGET_ID) return;
      CF_WIDGET_ID = turnstile.render('#cfBox', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: 'dark',
        size: 'flexible',          // visible widget
        appearance: 'always',      // show it
        callback: () => { msg.classList.remove('show'); } ,  // hide message once solved
        'expired-callback': () => { msg.classList.add('show'); },
        'error-callback':   () => { msg.textContent='Captcha failed, retry.'; msg.classList.add('show'); }
      });
    }
    window.cfOnload = renderTurnstile;           // if API calls onload → render
    (function waitCF(){                          // if it doesn't → poll
      if (window.turnstile) renderTurnstile();
      else setTimeout(waitCF, 50);
    })();

    // Block submit until there is a token; otherwise don’t spin forever
    form.addEventListener('submit', (e) => {
      if (TURNSTILE_SITE_KEY) {
        const token = CF_WIDGET_ID && turnstile.getResponse(CF_WIDGET_ID);
        if (!token) {
          e.preventDefault();
          msg.classList.add('show');
          document.getElementById('cfBox').scrollIntoView({ behavior:'smooth', block:'center' });
          return;
        }
      }
      btn.disabled = true; btn.textContent = 'Logging in...';
    });


  </script>
</body>
</html>
